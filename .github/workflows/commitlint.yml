# Commit Message Linter
#
# This workflow validates that PR titles and commit messages follow Conventional Commits format.
# It will FAIL the check if messages don't follow the format, preventing merge.
#
# Conventional Commit Format:
# <type>(<scope>): <description>
#
# Valid types: feat, fix, docs, style, refactor, perf, test, chore, ci, build
# Examples:
# - feat: add activity stream batching
# - fix: correct rate limit handling
# - docs: update README
# - chore: update dependencies
#
# To enable enforcement:
# In GitHub, enable branch protection on main:
# Settings → Branches → Add rule for main
# Check "Require status checks to pass"
# Select "Lint Commit Messages"

name: Lint Commit Messages

on:
  push:
    branches:
      - 'release/**'  # Trigger on version bump branches
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened, edited ]

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR title
        if: github.event_name == 'pull_request'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check if PR title follows conventional commit format
          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?!?:.+"; then
            echo "❌ PR title must follow Conventional Commits format"
            echo ""
            echo "Valid format: <type>(<scope>): <description>"
            echo ""
            echo "Valid types:"
            echo "  feat:     New feature"
            echo "  fix:      Bug fix"
            echo "  docs:     Documentation changes"
            echo "  style:    Code formatting (no logic change)"
            echo "  refactor: Code refactoring"
            echo "  perf:     Performance improvements"
            echo "  test:     Adding or updating tests"
            echo "  chore:    Maintenance tasks"
            echo "  ci:       CI/CD changes"
            echo "  build:    Build system changes"
            echo ""
            echo "Examples:"
            echo "  ✓ feat: add activity stream batching"
            echo "  ✓ fix: correct rate limit handling"
            echo "  ✓ docs: update README with examples"
            echo ""
            echo "Your PR title: '$PR_TITLE'"
            exit 1
          fi
          echo "✓ PR title follows Conventional Commits format"

      - name: Validate commit messages
        run: |
          # Get all commits in the PR (excluding merge commits)
          COMMITS=$(git log origin/main..HEAD --no-merges --pretty=format:"%s")

          echo "Checking commit messages..."
          echo ""

          # Check each commit
          INVALID_COUNT=0
          while IFS= read -r commit_msg; do
            # Skip empty lines
            [ -z "$commit_msg" ] && continue

            if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?!?:.+"; then
              echo "❌ Invalid: $commit_msg"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            else
              echo "✓ Valid: $commit_msg"
            fi
          done <<< "$COMMITS"

          if [ $INVALID_COUNT -gt 0 ]; then
            echo ""
            echo "Found $INVALID_COUNT invalid commit message(s)"
            echo ""
            echo "Please squash or amend commits to follow Conventional Commits format"
            exit 1
          fi

          echo ""
          echo "✓ All commit messages follow Conventional Commits format"
